/*! 🌸 LOTUS GLASS - COMPLETE JAVASCRIPT v5.0 | Optimized & Minified | 2025 */
(function(window,document){'use strict';const LotusGlass={version:'5.0.0',config:{apiUrl:'https://api.lotusglass.com',cdnUrl:'https://cdn.jsdelivr.net/gh/ksprovip7777/blogweb@main',debug:false,performance:{enableLazyLoading:true,enableServiceWorker:true,enablePrefetch:true}},cache:new Map(),state:{cart:[],wishlist:[],user:null,isLoading:false},utils:{debounce(func,wait,immediate){let timeout;return function executedFunction(...args){const later=()=>{timeout=null;if(!immediate)func(...args)};const callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)func(...args)}},throttle(func,limit){let inThrottle;return function(...args){if(!inThrottle){func.apply(this,args);inThrottle=true;setTimeout(()=>inThrottle=false,limit)}}},raf(callback){return window.requestAnimationFrame?window.requestAnimationFrame(callback):setTimeout(callback,16)},createElement(tag,className,content){const el=document.createElement(tag);if(className)el.className=className;if(content)el.innerHTML=content;return el},getElement(selector){return document.querySelector(selector)},getElements(selector){return document.querySelectorAll(selector)},addClass(el,className){if(el)el.classList.add(className)},removeClass(el,className){if(el)el.classList.remove(className)},toggleClass(el,className){if(el)el.classList.toggle(className)},hasClass(el,className){return el?el.classList.contains(className):false},setData(key,value){try{localStorage.setItem(`lotus_${key}`,JSON.stringify(value))}catch(e){console.warn('LocalStorage error:',e)}},getData(key,defaultValue=null){try{const item=localStorage.getItem(`lotus_${key}`);return item?JSON.parse(item):defaultValue}catch(e){console.warn('LocalStorage error:',e);return defaultValue}},removeData(key){try{localStorage.removeItem(`lotus_${key}`)}catch(e){console.warn('LocalStorage error:',e)}},formatPrice(price){return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(price)},formatDate(date){return new Intl.DateTimeFormat('vi-VN').format(new Date(date))},generateId(){return Math.random().toString(36).substr(2,9)},isValidEmail(email){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)},isValidPhone(phone){return/^[0-9+\-\s()]{10,15}$/.test(phone)},sanitizeHtml(str){const div=document.createElement('div');div.textContent=str;return div.innerHTML},copyToClipboard(text){if(navigator.clipboard){return navigator.clipboard.writeText(text)}else{const textArea=document.createElement('textarea');textArea.value=text;document.body.appendChild(textArea);textArea.select();document.execCommand('copy');document.body.removeChild(textArea);return Promise.resolve()}},showToast(message,type='info',duration=3000){const toast=this.createElement('div',`toast toast-${type}`,`<span>${this.sanitizeHtml(message)}</span><button class="toast-close">&times;</button>`);document.body.appendChild(toast);setTimeout(()=>this.addClass(toast,'show'),100);const closeBtn=toast.querySelector('.toast-close');if(closeBtn){closeBtn.addEventListener('click',()=>this.removeToast(toast))}setTimeout(()=>this.removeToast(toast),duration)},removeToast(toast){this.removeClass(toast,'show');setTimeout(()=>{if(toast.parentNode)toast.parentNode.removeChild(toast)},300)}},performance:{init(){this.setupLazyLoading();this.setupImageOptimization();this.setupPrefetching();this.monitorPerformance()},setupLazyLoading(){if('IntersectionObserver'in window){const imageObserver=new IntersectionObserver((entries,observer)=>{entries.forEach(entry=>{if(entry.isIntersecting){const img=entry.target;if(img.dataset.src){img.src=img.dataset.src;img.removeAttribute('data-src');LotusGlass.utils.removeClass(img,'lazy')}observer.unobserve(img)}})});LotusGlass.utils.getElements('img[data-src]').forEach(img=>imageObserver.observe(img))}},setupImageOptimization(){LotusGlass.utils.getElements('img').forEach(img=>{if(!img.loading)img.loading='lazy'})},setupPrefetching(){if('requestIdleCallback'in window){requestIdleCallback(()=>{const links=['store.html','about.html','contact.html'];links.forEach(href=>{const link=LotusGlass.utils.createElement('link');link.rel='prefetch';link.href=href;document.head.appendChild(link)})})}},monitorPerformance(){if('PerformanceObserver'in window){try{const observer=new PerformanceObserver(list=>{list.getEntries().forEach(entry=>{if(LotusGlass.config.debug){console.log(`Performance: ${entry.name} - ${entry.duration}ms`)}})});observer.observe({entryTypes:['navigation','paint','largest-contentful-paint']})}catch(e){console.warn('Performance monitoring error:',e)}}}},header:{init(){this.setupStickyHeader();this.setupSearch();this.setupMobileMenu();this.setupBadges();this.setupNavigation()},setupStickyHeader(){const header=LotusGlass.utils.getElement('#site-header');if(!header)return;let lastScrollY=window.scrollY;let ticking=false;const updateHeader=()=>{const scrollY=window.scrollY;if(scrollY>50){LotusGlass.utils.addClass(header,'scrolled')}else{LotusGlass.utils.removeClass(header,'scrolled')}if(scrollY>lastScrollY&&scrollY>200){header.style.transform='translateY(-100%)'}else{header.style.transform='translateY(0)'}lastScrollY=scrollY;ticking=false};const requestTick=()=>{if(!ticking){LotusGlass.utils.raf(updateHeader);ticking=true}};window.addEventListener('scroll',requestTick,{passive:true})},setupSearch(){const searchToggle=LotusGlass.utils.getElement('#searchToggle');if(!searchToggle)return;searchToggle.addEventListener('click',()=>{let searchModal=LotusGlass.utils.getElement('#searchModal');if(!searchModal){this.createSearchModal();searchModal=LotusGlass.utils.getElement('#searchModal')}if(typeof bootstrap!=='undefined'&&bootstrap.Modal){const modal=new bootstrap.Modal(searchModal);modal.show();searchModal.addEventListener('shown.bs.modal',()=>{const searchInput=searchModal.querySelector('input[type="search"]');if(searchInput)searchInput.focus()})}})},createSearchModal(){const modalHTML=`<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0"><h5 class="modal-title fw-bold" id="searchModalLabel"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="me-2"><path d="M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>Tìm kiếm sản phẩm</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button></div><div class="modal-body"><form id="headerSearchForm"><div class="input-group"><input type="search" class="form-control form-control-lg" placeholder="Nhập từ khóa tìm kiếm..." aria-label="Tìm kiếm sản phẩm" id="headerSearchInput"><button type="submit" class="btn btn-primary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L16.514 16.506M19 10.5C19 15.194 15.194 19 10.5 19C5.806 19 2 15.194 2 10.5C2 5.806 5.806 2 10.5 2C15.194 2 19 5.806 19 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button></div></form></div></div></div></div>`;document.body.insertAdjacentHTML('beforeend',modalHTML);const searchForm=LotusGlass.utils.getElement('#headerSearchForm');if(searchForm){searchForm.addEventListener('submit',this.handleSearch.bind(this))}},handleSearch(event){event.preventDefault();const searchInput=LotusGlass.utils.getElement('#headerSearchInput');const query=searchInput.value.trim();if(query){const searchModal=bootstrap.Modal.getInstance(LotusGlass.utils.getElement('#searchModal'));if(searchModal)searchModal.hide();if(typeof LotusGlassApp!=='undefined'){LotusGlassApp.navigateToPage('store',{search:query})}else{window.location.href=`#store?search=${encodeURIComponent(query)}`}}},setupMobileMenu(){const mobileMenu=LotusGlass.utils.getElement('#mobileMenu');if(mobileMenu){mobileMenu.addEventListener('show.bs.offcanvas',()=>{document.body.style.overflow='hidden'});mobileMenu.addEventListener('hide.bs.offcanvas',()=>{document.body.style.overflow=''})}},setupBadges(){this.updateCartBadge();this.updateWishlistBadge();window.addEventListener('storage',()=>{this.updateCartBadge();this.updateWishlistBadge()})},updateCartBadge(){const cartBadge=LotusGlass.utils.getElement('#cartBadge');if(cartBadge){const cart=LotusGlass.utils.getData('cart',[]);const cartCount=cart.reduce((total,item)=>total+(item.quantity||0),0);if(cartCount>0){cartBadge.textContent=cartCount>99?'99+':cartCount;cartBadge.style.display='flex'}else{cartBadge.style.display='none'}}},updateWishlistBadge(){const wishlistBadge=LotusGlass.utils.getElement('.wishlist-count');if(wishlistBadge){const wishlist=LotusGlass.utils.getData('wishlist',[]);const wishlistCount=wishlist.length;if(wishlistCount>0){wishlistBadge.textContent=wishlistCount>99?'99+':wishlistCount;wishlistBadge.style.display='flex'}else{wishlistBadge.style.display='none'}}},setupNavigation(){const currentHash=window.location.hash.slice(1)||'home';const navLinks=LotusGlass.utils.getElements('.nav-list a, .mobile-nav a');navLinks.forEach(link=>{const page=link.getAttribute('data-page')||link.getAttribute('href').replace('#','').replace('.html','');if(page===currentHash){LotusGlass.utils.addClass(link,'active')}else{LotusGlass.utils.removeClass(link,'active')}});window.addEventListener('hashchange',()=>this.setupNavigation())}},cart:{init(){this.loadCart();this.setupEventListeners()},loadCart(){LotusGlass.state.cart=LotusGlass.utils.getData('cart',[]);this.updateCartDisplay()},saveCart(){LotusGlass.utils.setData('cart',LotusGlass.state.cart);this.updateCartDisplay();LotusGlass.header.updateCartBadge()},addItem(product,quantity=1){const existingItem=LotusGlass.state.cart.find(item=>item.id===product.id);if(existingItem){existingItem.quantity+=quantity}else{LotusGlass.state.cart.push({...product,quantity})}this.saveCart();LotusGlass.utils.showToast(`Đã thêm ${product.name} vào giỏ hàng`,'success')},removeItem(productId){LotusGlass.state.cart=LotusGlass.state.cart.filter(item=>item.id!==productId);this.saveCart();LotusGlass.utils.showToast('Đã xóa sản phẩm khỏi giỏ hàng','info')},updateQuantity(productId,quantity){if(quantity<=0){this.removeItem(productId);return}const item=LotusGlass.state.cart.find(item=>item.id===productId);if(item){item.quantity=quantity;this.saveCart()}},clearCart(){LotusGlass.state.cart=[];this.saveCart();LotusGlass.utils.showToast('Đã xóa tất cả sản phẩm khỏi giỏ hàng','info')},getTotal(){return LotusGlass.state.cart.reduce((total,item)=>total+(item.price*item.quantity),0)},getItemCount(){return LotusGlass.state.cart.reduce((total,item)=>total+item.quantity,0)},updateCartDisplay(){const cartContainer=LotusGlass.utils.getElement('#cartItems');const cartTotal=LotusGlass.utils.getElement('#cartTotal');const cartCount=LotusGlass.utils.getElement('#cartCount');if(cartContainer){if(LotusGlass.state.cart.length===0){cartContainer.innerHTML='<div class="text-center py-5"><p class="text-muted">Giỏ hàng trống</p><a href="store.html" class="btn btn-primary">Tiếp tục mua sắm</a></div>'}else{cartContainer.innerHTML=LotusGlass.state.cart.map(item=>`<div class="cart-item" data-id="${item.id}"><div class="d-flex align-items-center"><img src="${item.image}" alt="${item.name}" class="cart-item-image"><div class="flex-grow-1 ms-3"><h6 class="mb-1">${item.name}</h6><p class="text-muted mb-0">${LotusGlass.utils.formatPrice(item.price)}</p></div><div class="quantity-controls"><button class="btn btn-sm btn-outline-secondary" onclick="LotusGlass.cart.updateQuantity('${item.id}',${item.quantity-1})">-</button><span class="mx-2">${item.quantity}</span><button class="btn btn-sm btn-outline-secondary" onclick="LotusGlass.cart.updateQuantity('${item.id}',${item.quantity+1})">+</button></div><button class="btn btn-sm btn-outline-danger ms-2" onclick="LotusGlass.cart.removeItem('${item.id}')">Xóa</button></div></div>`).join('')}}if(cartTotal){cartTotal.textContent=LotusGlass.utils.formatPrice(this.getTotal())}if(cartCount){cartCount.textContent=this.getItemCount()}},setupEventListeners(){document.addEventListener('click',event=>{if(event.target.matches('.add-to-cart')){event.preventDefault();const productCard=event.target.closest('.product-card');if(productCard){const product={id:productCard.dataset.id,name:productCard.querySelector('.product-title').textContent,price:parseFloat(productCard.dataset.price),image:productCard.querySelector('.product-image').src};this.addItem(product)}}})}},wishlist:{init(){this.loadWishlist();this.setupEventListeners()},loadWishlist(){LotusGlass.state.wishlist=LotusGlass.utils.getData('wishlist',[]);this.updateWishlistDisplay()},saveWishlist(){LotusGlass.utils.setData('wishlist',LotusGlass.state.wishlist);this.updateWishlistDisplay();LotusGlass.header.updateWishlistBadge()},addItem(product){const exists=LotusGlass.state.wishlist.find(item=>item.id===product.id);if(!exists){LotusGlass.state.wishlist.push(product);this.saveWishlist();LotusGlass.utils.showToast(`Đã thêm ${product.name} vào danh sách yêu thích`,'success')}else{LotusGlass.utils.showToast('Sản phẩm đã có trong danh sách yêu thích','info')}},removeItem(productId){LotusGlass.state.wishlist=LotusGlass.state.wishlist.filter(item=>item.id!==productId);this.saveWishlist();LotusGlass.utils.showToast('Đã xóa khỏi danh sách yêu thích','info')},toggleItem(product){const exists=LotusGlass.state.wishlist.find(item=>item.id===product.id);if(exists){this.removeItem(product.id)}else{this.addItem(product)}},isInWishlist(productId){return LotusGlass.state.wishlist.some(item=>item.id===productId)},clearWishlist(){LotusGlass.state.wishlist=[];this.saveWishlist();LotusGlass.utils.showToast('Đã xóa tất cả khỏi danh sách yêu thích','info')},updateWishlistDisplay(){const wishlistContainer=LotusGlass.utils.getElement('#wishlistItems');if(wishlistContainer){if(LotusGlass.state.wishlist.length===0){wishlistContainer.innerHTML='<div class="text-center py-5"><p class="text-muted">Danh sách yêu thích trống</p><a href="store.html" class="btn btn-primary">Khám phá sản phẩm</a></div>'}else{wishlistContainer.innerHTML=LotusGlass.state.wishlist.map(item=>`<div class="col-md-6 col-lg-4 mb-4"><div class="product-card" data-id="${item.id}"><img src="${item.image}" alt="${item.name}" class="product-image"><div class="product-info"><h5 class="product-title">${item.name}</h5><p class="product-price">${LotusGlass.utils.formatPrice(item.price)}</p><div class="product-actions"><button class="btn btn-primary btn-sm add-to-cart">Thêm vào giỏ</button><button class="btn btn-outline-danger btn-sm" onclick="LotusGlass.wishlist.removeItem('${item.id}')">Xóa</button></div></div></div></div>`).join('')}}LotusGlass.utils.getElements('.wishlist-btn').forEach(btn=>{const productId=btn.closest('.product-card').dataset.id;if(this.isInWishlist(productId)){LotusGlass.utils.addClass(btn,'active')}else{LotusGlass.utils.removeClass(btn,'active')}})},setupEventListeners(){document.addEventListener('click',event=>{if(event.target.matches('.wishlist-btn')||event.target.closest('.wishlist-btn')){event.preventDefault();const btn=event.target.matches('.wishlist-btn')?event.target:event.target.closest('.wishlist-btn');const productCard=btn.closest('.product-card');if(productCard){const product={id:productCard.dataset.id,name:productCard.querySelector('.product-title').textContent,price:parseFloat(productCard.dataset.price),image:productCard.querySelector('.product-image').src};this.toggleItem(product);LotusGlass.utils.toggleClass(btn,'active')}}})}},forms:{init(){this.setupValidation();this.setupSubmission()},setupValidation(){LotusGlass.utils.getElements('form').forEach(form=>{form.addEventListener('submit',event=>{if(!this.validateForm(form)){event.preventDefault();event.stopPropagation()}LotusGlass.utils.addClass(form,'was-validated')})})},validateForm(form){let isValid=true;const requiredFields=form.querySelectorAll('[required]');requiredFields.forEach(field=>{if(!field.value.trim()){isValid=false;this.showFieldError(field,'Trường này là bắt buộc')}else if(field.type==='email'&&!LotusGlass.utils.isValidEmail(field.value)){isValid=false;this.showFieldError(field,'Email không hợp lệ')}else if(field.type==='tel'&&!LotusGlass.utils.isValidPhone(field.value)){isValid=false;this.showFieldError(field,'Số điện thoại không hợp lệ')}else{this.clearFieldError(field)}});return isValid},showFieldError(field,message){this.clearFieldError(field);const errorDiv=LotusGlass.utils.createElement('div','invalid-feedback',message);field.parentNode.appendChild(errorDiv);LotusGlass.utils.addClass(field,'is-invalid')},clearFieldError(field){const errorDiv=field.parentNode.querySelector('.invalid-feedback');if(errorDiv)errorDiv.remove();LotusGlass.utils.removeClass(field,'is-invalid')},setupSubmission(){document.addEventListener('submit',event=>{const form=event.target;if(form.matches('.ajax-form')){event.preventDefault();this.submitForm(form)}})},async submitForm(form){const formData=new FormData(form);const submitBtn=form.querySelector('[type="submit"]');const originalText=submitBtn.textContent;submitBtn.disabled=true;submitBtn.innerHTML='<span class="loading-spinner"></span> Đang xử lý...';try{const response=await fetch(form.action||'#',{method:form.method||'POST',body:formData});if(response.ok){LotusGlass.utils.showToast('Gửi thành công!','success');form.reset()}else{throw new Error('Có lỗi xảy ra')}}catch(error){LotusGlass.utils.showToast('Có lỗi xảy ra, vui lòng thử lại','error')}finally{submitBtn.disabled=false;submitBtn.textContent=originalText}}},init(){this.performance.init();this.header.init();this.cart.init();this.wishlist.init();this.forms.init();document.addEventListener('DOMContentLoaded',()=>{LotusGlass.utils.removeClass(document.body,'loading');if(LotusGlass.config.debug){console.log('🌸 Lotus Glass initialized successfully')}});if('serviceWorker'in navigator&&LotusGlass.config.performance.enableServiceWorker){navigator.serviceWorker.register('/sw.js').catch(err=>console.warn('SW registration failed:',err))}}};LotusGlass.init();window.LotusGlass=LotusGlass})(window,document);
